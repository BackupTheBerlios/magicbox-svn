diff -Nru linux-2.6.18/drivers/ide/Kconfig linux-2.6.18-magicbox2-ide-cf/drivers/ide/Kconfig
--- linux-2.6.18/drivers/ide/Kconfig	2006-09-20 05:42:06.000000000 +0200
+++ linux-2.6.18-magicbox2-ide-cf/drivers/ide/Kconfig	2006-10-13 21:40:41.000000000 +0200
@@ -926,6 +926,14 @@
 
 	  If unsure, say N.
 
+config BLK_DEV_MAGICBOX_IDE
+	bool "MagicBox 2.0 CF IDE support"
+	depends on 4xx && IDE=y && BLK_DEV_IDE=y
+	help
+	  This option provides support for IDE on MagicBox 2.0 boards.
+
+	  If unsure, say N.
+
 choice
 	prompt "Type of MPC8xx IDE interface"
 	depends on BLK_DEV_MPC8xx_IDE
diff -Nru linux-2.6.18/drivers/ide/Makefile linux-2.6.18-magicbox2-ide-cf/drivers/ide/Makefile
--- linux-2.6.18/drivers/ide/Makefile	2006-09-20 05:42:06.000000000 +0200
+++ linux-2.6.18-magicbox2-ide-cf/drivers/ide/Makefile	2006-10-13 21:40:41.000000000 +0200
@@ -36,6 +36,7 @@
 # built-in only drivers from ppc/
 ide-core-$(CONFIG_BLK_DEV_MPC8xx_IDE)	+= ppc/mpc8xx.o
 ide-core-$(CONFIG_BLK_DEV_IDE_PMAC)	+= ppc/pmac.o
+ide-core-$(CONFIG_BLK_DEV_MAGICBOX_IDE)	+= ppc/magicbox_ide.o
 
 # built-in only drivers from h8300/
 ide-core-$(CONFIG_H8300)		+= h8300/ide-h8300.o
diff -Nru linux-2.6.18/drivers/ide/ide.c linux-2.6.18-magicbox2-ide-cf/drivers/ide/ide.c
--- linux-2.6.18/drivers/ide/ide.c	2006-09-20 05:42:06.000000000 +0200
+++ linux-2.6.18-magicbox2-ide-cf/drivers/ide/ide.c	2006-10-13 21:40:41.000000000 +0200
@@ -1836,6 +1836,13 @@
 #ifdef CONFIG_H8300
 	h8300_ide_init();
 #endif
+#ifdef CONFIG_BLK_DEV_MAGICBOX_IDE
+	{
+		extern void ide_magicbox_init();
+		ide_magicbox_init();
+	}
+#endif
+
 }
 
 void ide_register_subdriver(ide_drive_t *drive, ide_driver_t *driver)
diff -Nru linux-2.6.18/drivers/ide/ppc/magicbox_ide.c linux-2.6.18-magicbox2-ide-cf/drivers/ide/ppc/magicbox_ide.c
--- linux-2.6.18/drivers/ide/ppc/magicbox_ide.c	1970-01-01 01:00:00.000000000 +0100
+++ linux-2.6.18-magicbox2-ide-cf/drivers/ide/ppc/magicbox_ide.c	2006-10-13 22:18:26.000000000 +0200
@@ -0,0 +1,71 @@
+/* Driver for MagicBox 2.0 onboard CompactFlash adapter.
+ *
+ * Driver written with an invaluable help of Wojtek Kaniewski.
+ * Modifications by Karol Lewandowski.
+ *
+ * GNU General Public License.
+ */
+
+#include <linux/types.h>
+#include <linux/mm.h>
+#include <linux/interrupt.h>
+#include <linux/blkdev.h>
+#include <linux/hdreg.h>
+#include <linux/ide.h>
+#include <linux/delay.h>
+
+
+#define UIC0_PR 0xc4
+#define UIC0_TR 0xc5
+#define IRQ 25
+
+static int ide_offsets[IDE_NR_PORTS] = {1, 3, 5, 7, 9, 11, 13, 15, -1, -1};
+
+static void __init ide_magicbox_register(unsigned long addr,
+					 unsigned long caddr, int irq)
+{
+	hw_regs_t hw;
+	ide_hwif_t *hwif;
+
+  	memset(&hw, 0, sizeof(hw));
+	ide_setup_ports(&hw, addr, ide_offsets, caddr + 0xd, 0, NULL,irq);
+
+	if (ide_register_hw(&hw, &hwif) != -1)
+	{
+		printk(KERN_NOTICE "magicbox-cf: Found IDE-CF adapter\n");
+		hwif->mmio = 2;
+		hwif->drives[0].unmask = 1;
+		default_hwif_mmiops(hwif);
+	}
+}
+
+void __init ide_magicbox_init(void)
+{
+	volatile u16 *addr;
+	volatile u16 *caddr;
+
+	/* Turn on PerWE instead of PCIsomething */
+	mtdcr(DCRN_CPC0_PCI_BASE, mfdcr(DCRN_CPC0_PCI_BASE) | (0x80000000L >> 27));
+	
+	/* PerCS2 (CF's CS0): base 0xff100000, 16-bit, rw */
+	mtdcr(DCRN_EBC_BASE, 0x02);
+	mtdcr(DCRN_EBC_BASE + 1, 0xff11a000);
+	mtdcr(DCRN_EBC_BASE, 0x12);
+	mtdcr(DCRN_EBC_BASE + 1, 0x080bd800);
+
+	/* PerCS1 (CF's CS1): base 0xff200000, 16-bit, rw */
+	mtdcr(DCRN_EBC_BASE, 0x01);
+	mtdcr(DCRN_EBC_BASE + 1, 0xff21a000);
+	mtdcr(DCRN_EBC_BASE, 0x11);
+	mtdcr(DCRN_EBC_BASE + 1, 0x080bd800);
+
+	/* Remap physical address space */
+	addr = ioremap_nocache(0xff100000, 4096);
+	caddr = ioremap_nocache(0xff200000, 4096);
+
+	/* Set interrupt to low-to-high-edge-triggered */
+	mtdcr(UIC0_TR, mfdcr(UIC0_TR) & ~(0x80000000L >> IRQ));
+	mtdcr(UIC0_PR, mfdcr(UIC0_PR) | (0x80000000L >> IRQ));
+
+	ide_magicbox_register((unsigned long)addr, (unsigned long)caddr, IRQ);
+}
